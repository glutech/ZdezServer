package cn.com.zdez.service;

import java.util.ArrayList;
import java.util.List;

import cn.com.zdez.cache.ZdezMsgCache;
import cn.com.zdez.dao.ZdezMsgDao;
import cn.com.zdez.po.ZdezMsg;
import cn.com.zdez.util.ContentOperation;
import cn.com.zdez.vo.ZdezMsgVo;

public class ZdezMsgService {

	ZdezMsgDao dao = new ZdezMsgDao();

	public synchronized boolean newZdezMsg(ZdezMsg zMsg, String[] grade,
			String[] major, List<Integer> destUsers, String rootPath) {
		boolean flag = false;
		if (dao.newZdezMsg(zMsg)) {
			int zdezMsgId = dao.getLatestZdezMsgId();
			if (dao.newZdezMsg_Grade(zdezMsgId, grade)
					&& dao.newZdezMsg_Major(zdezMsgId, major)
					&& dao.newZdezMsg_Receivers(zdezMsgId, destUsers)) {

				//将内容写入html文件，用于网页显示
				if(new ContentOperation().SaveContent("zdezMsg", zdezMsgId, zMsg.getContent(), rootPath)) {
					flag = true;
				}
				
				List<ZdezMsgVo> list = new ArrayList<ZdezMsgVo>();
				List<Integer> zdezMsgIdList = new ArrayList<Integer>();
				zdezMsgIdList.add(zdezMsgId);
				list = dao.getZdezMsgAll(zdezMsgIdList);

				// 给微软服务器发送

				// 缓存
				new ZdezMsgCache().cacheZdezMsg(list);
			} else {
				dao.roll_Back(zdezMsgId);
			}
		}
		return flag;
	}
	
	public synchronized List<ZdezMsgVo> getMsgToUpdate(int stuId) {
		return dao.getMsgToUpdate(stuId);
	}
	
	public void updateZdezMsgReceived(int stuId, String[] zdezMsgIdArray) {
		List<Integer> zdezMsgIdList = new ArrayList<Integer>();
		for (int i = 0, count = zdezMsgIdArray.length; i < count; i++) {
			zdezMsgIdList.add(Integer.parseInt(zdezMsgIdArray[i]));
		}
		dao.updateZdezMsgReceived(stuId, zdezMsgIdList);
	}
	
	public List<ZdezMsgVo> getZdezMsgAll(List<Integer> zdezMsgIdList) {
		return dao.getZdezMsgAll(zdezMsgIdList);
	}
	
	public int getZdezMsgCount() {
		return dao.getZdezMsgCount();
	}
	
	public List<ZdezMsgVo> getZdezMsgByPage(int start, int end) {
		List<ZdezMsgVo> list = new ArrayList<ZdezMsgVo>();
		List<Integer> idList = dao.getZdezMsgIdList(start, end);
		list = dao.getZdezMsgAll(idList);
		return list;
	}
	
	public int getZdezMsgQueryCount(String keyword) {
		return dao.getZdezMsgQueryCount(keyword);
	}
	
	public List<ZdezMsgVo> getZdezMsgQueryByPage(int start, int end, String keyword) {
		List<ZdezMsgVo> list = new ArrayList<ZdezMsgVo>();
		List<Integer> idList = dao.getZdezMsgIdList(start, end, keyword);
		list = dao.getZdezMsgAll(idList);
		return list;
	}
	
	public ZdezMsg getZdezMsgById(int zdezMsgId) {
		return dao.getZdezMsgById(zdezMsgId);
	}
	
	public List<Integer> getGradeIdListByMsgId(int zdezMsgId) {
		return dao.getGradeIdListByMsgId(zdezMsgId);
	}
	
	public List<Integer> getMajorIdListByMsgId(int zdezMsgId) {
		return dao.getMajorIdListByMsgId(zdezMsgId);
	}
	
	public List<Integer> getDestUsersListByMsgId(int zdezMsgId) {
		return dao.getDestUsersListByMsgId(zdezMsgId);
	}

}
